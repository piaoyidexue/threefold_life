
# 《圣焰:三重人生》 开发执行策划案 (GDD v5.0 - Final Release)

| 项目 | 内容 |
| :--- | :--- |
| **项目名称** | 圣焰:三重人生 (Sacred Flame: Three Lives) |
| **游戏类型** | RPG + 塔防 + 身份推理 (Social Deduction) |
| **开发平台** | Dota 2 Workshop Tools (Lua + TypeScript + Panorama) |
| **玩家人数** | 8人 (标准局) |
| **单局时长** | 30 分钟 (15 波次) |

---

## 1. 游戏核心循环 (Game Loop)

游戏严格按照 **天数 (Day)** 进行循环。第 15 天为最终决战。

### 1.1 时间轴详解
*   **准备阶段 (Pre-Game)**: `60秒`
    *   玩家选择 Dota2 原生英雄。
    *   系统后台随机分配身份（UI仅对自己显示）。
    *   所有玩家出生在基地“圣焰”旁，获得初始金币 `600`。
*   **循环阶段 (Days 1-14)**: `5分钟/天`
    *   **白天 (Day Phase)**: `180秒`
        *   **视野**: 取决于光辉度。
        *   **机制**: 开启【审判台】交互；开启【圣坛】交互；野区刷新被动野怪。
        *   **限制**: 玩家间默认开启 `modifier_invulnerable` (不可攻击队友)，内奸需变身打破。
    *   **夜晚 (Night Phase)**: `120秒`
        *   **事件**: 强制传送所有玩家回城。
        *   **机制**: 幽灵玩家复活（扣除基地 5% HP上限）；怪物潮生成；关闭审判台。
*   **决战阶段 (Day 15)**: `不限时`
    *   最终 Boss 降临。
    *   检测 **【暗影锁】** 状态。

---

## 2. 角色阵营与详细技能 (Roles & Abilities)

### 2.1 圣焰守护者 (Guardians - 6人)
*   **身份目标**: 圣焰存活，且击杀最终 Boss。
*   **被动机制**: `Ability_Guardian_Passive`
    *   **命运连结**: 造成的击杀经验 `100%` 进入【团队经验池】，平分给所有存活玩家。
    *   **光辉信仰**: 允许使用【光辉】资源购买商店物品。
*   **死亡状态**:
    *   变为隐形单位“幽灵”，移速 `550`，拥有高空视野，无法攻击/使用物品。

### 2.2 暗影潜行者 (Traitor - 1人)
*   **身份目标**: 圣焰生命值 <= 0。
*   **被动机制**: `Ability_Traitor_Passive`
    *   **灵魂寄生**: 截流团队经验的 `20%` 存入自身隐藏池。
    *   **暗影行囊**: 允许访问内奸专属商店（UI面板）。
*   **主动技能 (未变身状态)**:
    *   **Q - 破坏圣坛**: `3秒` 吟唱，摧毁一个已激活的圣坛。
    *   **R - 遁入暗影 (变身)**:
        *   **效果**: 变身为“魔王形态”（模型替换为影魔/末日），血量翻倍，解除和平锁定，获得新技能组。
        *   **持续**: `60秒`。 **CD**: `180秒`。
*   **魔王形态技能 (变身后)**:
    *   **Q - 毁灭阴影**: 三连压，高额AOE伤害。
    *   **W - 恐惧嚎叫**: 周围好人减少 `50%` 攻击力/护甲，持续 `8秒`。
    *   **E - 盛宴 (被动)**: 对英雄造成相当于最大生命值 `5%` 的额外伤害。
    *   **R - 处决**: 对血量低于 `30%` 的英雄造成斩杀（无视无敌/复活）。

### 2.3 狂热信徒 / 审判者 (Judge - 1人)
*   **身份目标**: 场上除自己外存活人数 `<= 1` 且 圣焰被毁。
*   **阶段一：信徒 (The Believer)**
    *   **状态**: 极为脆弱 (-20% 全属性)，无法贡献也无法获得共享经验。
    *   **任务**: 死亡。死后触发觉醒。
*   **阶段二：审判者 (The Judge)**
    *   **复活**: 信徒死后 `30秒` 在墓地复活为 Boss 单位（模型：孽主/死灵法）。
    *   **被动**: 对“内奸”造成 `200%` 真实伤害；对“圣焰”造成 `200%` 攻城伤害。
    *   **主动技能**:
        *   **Q - 灵魂收割**: 每杀死一个单位，永久增加 `5` 点攻击力。
        *   **W - 强制决斗**: 强制一个目标攻击自己，持续 `5秒`。
        *   **R - 末日丧钟**: (仅当存活人数 > 4 可用) 开启大逃杀模式，停止刷怪，全员敌对。

---

## 3. 经济与资源系统 (Economy & Resources)

### 3.1 核心资源：光辉 (Radiance)
这是一个全队共享的 Global 变量，取值 `0 - 100`。

| 行为 | 光辉度变化 | 备注 |
| :--- | :--- | :--- |
| **击杀普通怪** | `+0.5` | - |
| **击杀精英怪** | `+5.0` | - |
| **白天自然衰减** | `-0.2 / 秒` | 约 -36/白天 |
| **夜晚自然衰减** | `-0.5 / 秒` | 约 -60/夜晚 |
| **购买: 团队光环** | `-15` | 提供全队攻速/回血 |
| **购买: 修复圣焰** | `-20` | 修复基地 20% 血量 |
| **动作: 发起审判** | **`-25`** | 极高昂的代价 |
| **惩罚: 投错好人** | **`-30`** | 瞬间天黑 |

### 3.2 阈值效果 (Thresholds)
*   **[76-100] 圣辉**: 全图视野，全队 HP 回复 +2%。
*   **[26-75] 微光**: 正常 Dota2 视野（1800/800）。
*   **[0-25] 黯淡**: 视野降低至 400（仅身边），怪物暴击率 +30%。

### 3.3 内奸资源：暗影碎片 (Shards)
内奸的私有货币。
*   **获取**: 随时间增长 (+2/秒) + 补刀/反补 (+5/个)。
*   **内奸商店 (UI)**:
    1.  **怪物强化卡 (500碎片)**: 下一波怪物获得 [魔免 / 急速 / 致命一击] 之一。
    2.  **暗影守卫 (200碎片)**: 插眼，仅内奸可见的视野。
    3.  **血月契约 (3000碎片)**: 开启终极挑战（锁光辉100，内奸强制显形，限时拆家）。

---

## 4. 关键博弈机制 (Game Mechanics)

### 4.1 审判台系统 (Judgment System)
*   **交互**: 点击基地旁的“审判台”建筑。
*   **流程**:
    1.  玩家 A 支付 25 光辉发起投票。
    2.  弹出全屏 UI，显示所有存活玩家头像。
    3.  投票时间 `30秒`。需 `>50%` 存活玩家同意。
*   **结算**:
    *   **目标是内奸**: 内奸死亡（复活时间=999秒）。**返还内奸窃取的经验值给全队**。
    *   **目标是好人**: 目标死亡。发起者 A **直接死亡**。光辉 **-30**。内奸获得 **【魔神降临】** Buff。

### 4.2 暗影锁 (Shadow Lock) - *程序重点*
*   **逻辑**: 在 `DamageFilter` 中检测。
*   **条件**: `IsFinalBoss(victim)` AND `IsTraitorAlive()`
*   **效果**:
    *   `damage_reduction = 90%`
    *   每秒在 Boss 头顶弹出浮动文字：“叛徒存活，魔王无敌！”
    *   Boss 血条上方 UI 显示**【紫色锁头】**图标。

### 4.3 圣坛争夺 (Altar Event)
*   **生成**: 白天开始时，在地图 (X: ±3000, Y: ±3000) 坐标刷新 4 个圣坛。
*   **激活**: 英雄在圣坛范围内停留 `10秒` -> 圣坛变绿。
    *   *奖励*: 夜晚基地护甲 +5 / 每个。
*   **破坏**: 内奸在已激活圣坛停留 `5秒` -> 圣坛变红（失效）。

---

## 5. UI/UX 设计清单 (Panorama Tasks)

### 5.1 顶部信息栏 (HUD Top Bar)
*   **布局**:
    *   [左]: **天数/波次** (Day 3 / Wave 3)。
    *   [中]: **光辉度条**。
        *   进度条颜色需随数值渐变 (金 -> 蓝 -> 紫黑)。
        *   若光辉 < 25，边缘闪烁红色警报。
    *   [右]: **圣焰血量** (数值 + 百分比)。

### 5.2 暗影行囊 (Shadow Bag)
*   **组件**: 一个由于 `HasModifier("modifier_traitor_passive")` 才显示的 Panel。
*   **位置**: 屏幕右下角，物品栏上方。
*   **功能**:
    *   显示【暗影碎片】数量。
    *   Grid 列表展示可购买的内奸道具。
    *   点击图标直接扣除碎片并生效（不进入 Dota 库存）。

### 5.3 身份卡 (Role Card)
*   游戏开始 `0:00` 时弹出。
*   **样式**:
    *   **守护者**: 蓝色背景，盾牌图标。文案：“守护圣焰，找出叛徒。”
    *   **潜行者**: 紫色背景，匕首图标。文案：“**警告：若你在决战时存活，魔王将获得无敌护盾。**” (强调博弈点)
    *   **信徒**: 灰色背景，面具图标。文案：“寻求死亡，以此飞升。”

---

## 6. 技术实现架构 (Technical Architecture)

### 6.1 文件结构 (ModDota Standard)
```text
game/dota_addons/sacred_flame/
├── scripts/
│   ├── vscripts/
│   │   ├── addon_game_mode.lua        # 入口，初始化 filters
│   │   ├── GameConfig.lua             # 常量表 (金币、光辉衰减率)
│   │   ├── internal/                  # 工具库
│   │   ├── components/
│   │   │   ├── RoleManager.lua        # 身份分配、检测内奸存活
│   │   │   ├── RadianceSystem.lua     # 光辉度增减、NetTable同步
│   │   │   ├── ExperienceSystem.lua   # 经验截流、返还逻辑
│   │   │   ├── JudgmentSystem.lua     # 投票逻辑
│   │   │   └── ShadowLock.lua         # Boss无敌逻辑
│   │   └── filters/
│   │   │   ├── DamageFilter.lua       # 伤害拦截 (暗影锁)
│   │   │   └── XPFilter.lua           # 经验拦截 (寄生)
│   └── npc/
│       ├── npc_units_custom.txt       # 定义 圣焰、圣坛、怪物
│       ├── npc_abilities_custom.txt   # 定义 变身、审判者技能
│       └── npc_items_custom.txt       # 定义 内奸道具
└── content/
    └── panorama/
        ├── layout/custom_game/
        │   ├── hud_radiance.xml       # 顶部UI
        │   ├── hud_shadow_bag.xml     # 内奸背包
        │   └── hud_judgment.xml       # 投票面板
        └── scripts/custom_game/...
```

### 6.2 核心算法代码片段 (Lua)

**A. 经验截流 (XP Leech)**
```lua
-- filters/XPFilter.lua
function GameMode:FilterExperience(filterTable)
    local hero_index = filterTable["experience_ent_index_const"]
    local hero = EntIndexToHScript(hero_index)
    local amount = filterTable["experience"]

    -- 只针对好人，且内奸活着
    if RoleManager:IsGuardian(hero) and RoleManager:IsTraitorAlive() then
        local leech_amount = amount * 0.2
        filterTable["experience"] = amount - leech_amount

        -- 存入后台池
        RoleManager:AddStolenXP(leech_amount)

        -- 可选：发送Debug信息给内奸
        -- CustomGameEventManager:Send_ServerToPlayer(traitor_player, ...)
    end

    return true
end
```

**B. 处决返还 (Execution Refund)**
```lua
-- components/JudgmentSystem.lua
function Judgment:OnTraitorExecuted()
    local total_xp = RoleManager:GetStolenXP()
    local guardians = RoleManager:GetAliveGuardians()

    local xp_per_person = total_xp / #guardians

    for _, hero in pairs(guardians) do
        hero:AddExperience(xp_per_person, 0, false, false)
        SendOverheadEventMessage(nil, OVERHEAD_ALERT_XP, hero, xp_per_person, nil)
    end

    GameRules:SendCustomMessage("叛徒已死！窃取的能量回归了！", 0, 0)
end
```

---

## 7. 反作弊与防坑机制 (Anti-Griefing)

为了防止单人破坏游戏体验：

1.  **开局保护**: 前 `10分钟` 禁止使用审判台，防止乱票。
2.  **圣火重燃 (Fail-safe)**:
    *   触发条件：内奸开启【血月契约】或变身后，在 `30秒` 内死亡（判定为秒送）。
    *   效果：圣焰生命值回满，所有已死好人复活。
    *   目的：防止内奸太菜导致好人毫无体验地赢了，或者内奸恶意送人头。
3.  **挂机检测**: 若玩家 `3分钟` 无操作，且持有大量金币/光辉，系统自动将其金币平分给队友，并托管该英雄跟随队友。

---

## 8. 美术资源需求 (Assets List)

1.  **模型**:
    *   圣焰基地: 使用 `Ancient` 或 自定义火焰塔模型。
    *   圣坛: 使用 `Shrine` 模型，需红/绿两种材质变体。
    *   内奸变身: `Shadow Fiend` (黑色特效版)。
    *   审判者: `Necrophos` (加大体型，幽灵特效)。
2.  **特效**:
    *   `particle_radiance_bar`: 顶部的火焰UI特效。
    *   `particle_shadow_lock`: Boss头顶的紫色锁链特效。
    *   `particle_soul_leech`: 经验获取时的紫色流逝特效。
3.  **音效**:
    *   审判开始: 沉重的钟声。
    *   处决: 雷劈声。
    *   光辉过低: 心跳声 + 低语声。

---

这份文档现在可以直接分发给：
*   **程序**: 开始搭建 `addon_game_mode.lua` 和 Filter 逻辑。
*   **UI**: 照着第 5 节画图。
*   **策划**: 对照第 3 节填 KV 表。
